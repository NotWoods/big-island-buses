<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta charset="utf-8" />
    <title>Roads API Demo</title>
    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0px;
        padding: 0px;
      }

      #panel {
        position: absolute;
        top: 5px;
        left: 50%;
        margin-left: -180px;
        z-index: 5;
        background-color: #fff;
        padding: 5px;
        border: 1px solid #999;
      }

      #bar {
        width: 240px;
        background-color: rgba(255, 255, 255, 0.75);
        margin: 8px;
        padding: 4px;
        border-radius: 4px;
      }

      #autoc {
        width: 100%;
        box-sizing: border-box;
      }
    </style>

    <script src="https://www.gstatic.com/external_hosted/jquery2.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?libraries=drawing,places&key=AIzaSyAmRiFwEOokwUHYXK1MqYl5k2ngHoWGJBw"></script>
    <script>
      var apiKey = 'AIzaSyAmRiFwEOokwUHYXK1MqYl5k2ngHoWGJBw';

      var map;
      var drawingManager;
      var placeIdArray = [];
      var snappedPolyline;
      var markers = [];
      var snappedCoordinates = [];
      var path = []

      fetch('/big-island-buses/api.json')
        .then((res) => res.json())
        .then((json) => {
          window.api = json;
        });

      function initialize() {
        var mapOptions = {
          zoom: 12,
          center: { lat:19.62632617125115, lng: -155.53725046941753 },
        };
        map = new google.maps.Map(document.getElementById('map'), mapOptions);

        map.addListener("click", (mapsMouseEvent) => {
          const text = JSON.stringify(mapsMouseEvent.latLng.toJSON())
          navigator.clipboard.writeText(text)
        });

      }

      function tripPoints(routeId, tripId) {
        if (!tripId) {
          const parts = routeId.split('/');
          routeId = parts[0]
          tripId = parts[1]
        }
        const trip = api.routes[routeId].trips[tripId];
        return trip.stop_times.map(st => st.stop_id);
      }

      /**
       * Snap a user-created polyline to roads and draw the snapped path
       * @param {(string | { lat: number, lng: number })[]} path
       */
      function runSnapToRoad() {
        markers.forEach(m => m.setMap(null))
        markers = []
        snappedPolyline?.setMap(null)

        const pathValues = path.map((point) => {
          if (typeof point === 'string') {
            if (point.includes(',')) {
              const [lat, lng] = point.split(',').map(p => parseFloat(p))
              point = { lat, lng }
            } else {
              point = api.stops[point].position
            }
          }
          return point;
        });

        markers = pathValues.map((point, i) => {
          const marker = new google.maps.Marker({
            position: point,
            map,
            title: `[${i}] ${path[i]}`,
            draggable: true,
          })
          marker.addListener("dragend", () => {
            path[i] = marker.getPosition().toJSON()
          });
          return marker;
        })

        $.get(
          'https://roads.googleapis.com/v1/snapToRoads',
          {
            interpolate: true,
            key: apiKey,
            path: pathValues.map(point => `${point.lat},${point.lng}`).join('|'),
          },
          function (data) {
            processSnapToRoadResponse(data, path);
            drawSnappedPolyline();
          },
        );
      }

      // Store snapped polyline returned by the snap-to-road service.
      function processSnapToRoadResponse(data, origPath) {
        snappedCoordinates = [];
        placeIdArray = [];
        for (var i = 0; i < data.snappedPoints.length; i++) {
          var latlng = new google.maps.LatLng(
            data.snappedPoints[i].location.latitude,
            data.snappedPoints[i].location.longitude,
          );
          snappedCoordinates.push(latlng);
          placeIdArray.push(data.snappedPoints[i].placeId);
        }
      }

      // Draws the snapped polyline (after processing snap-to-road response).
      function drawSnappedPolyline() {
        snappedPolyline = new google.maps.Polyline({
          path: snappedCoordinates,
          strokeColor: '#add8e6',
          strokeWeight: 4,
          strokeOpacity: 0.9,
        });

        snappedPolyline.setMap(map);
      }

      $(window).load(initialize);
    </script>
  </head>

  <body>
    <div id="map"></div>
  </body>
</html>
